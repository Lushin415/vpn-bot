package services

import (
	"fmt"
	"log"
	"time"

	"vpn-bot/internal/db"
)

// SendSubscriptionReminders –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ —Å–∫–æ—Ä–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.
// –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Å—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ AssignedAt + 30 –¥–Ω–µ–π.
// üî¥ ! –ï—Å–ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏, –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É —Ä–∞—Å—á–µ—Ç–∞.
func SendSubscriptionReminders() {
	var keys []db.VLESSKey
	// –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º AssignedAt.
	if err := db.DB.Where("is_used = ? AND assigned_at IS NOT NULL", true).Find(&keys).Error; err != nil {
		log.Printf("üî¥ –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫: %v", err)
		return
	}

	now := time.Now()
	for _, key := range keys {
		if key.AssignedAt == nil {
			continue
		}
		// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 30-–¥–Ω–µ–≤–Ω—ã–π —Å—Ä–æ–∫).
		expiration := key.AssignedAt.Add(30 * 24 * time.Hour)
		daysLeft := int(expiration.Sub(now).Hours() / 24)

		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å —Ä–æ–≤–Ω–æ 7 –∏–ª–∏ 3 –¥–Ω—è.
		if daysLeft == 7 || daysLeft == 3 {
			if key.UserID != nil {
				message := fmt.Sprintf("‚è≥ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ %d –¥–Ω–µ–π. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –µ—ë!", daysLeft)
				// –§—É–Ω–∫—Ü–∏—è SendMessage —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∏–∂–µ –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∞ ‚Äì –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram Bot API.
				SendMessage(int64(*key.UserID), message)
			}
		}
	}
}

// SendMessage –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram.
// üî¥ ! –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç—É –∑–∞–≥–ª—É—à–∫—É –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
/*func SendMessage(chatID int64, text string) {
	log.Printf("–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %d: %s", chatID, text)
}*/
